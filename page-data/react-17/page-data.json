{"componentChunkName":"component---src-templates-blog-post-js","path":"/react-17/","result":{"data":{"site":{"siteMetadata":{"title":"Overblog","author":"zit"}},"markdownRemark":{"id":"7bea71bf-be34-5cc9-99be-28308ddbc0a2","html":"<p>看完三篇发布文档的感受就是，</p>\n<ol>\n<li>react 本次大版本更新强调<strong>渐进式升级</strong>，避免一个应用的整体修改。</li>\n<li>已有API无变化，内在有些改变。</li>\n<li>对我来说是好事，毕竟现在的原理还没搞清楚，再来新的很难顶。</li>\n</ol>\n<p>下面是具体的变化：</p>\n<h2 id=\"无新特性\"><a href=\"#%E6%97%A0%E6%96%B0%E7%89%B9%E6%80%A7\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>无新特性</h2>\n<p>React v17.0 RC 版本发布在北京时间 8 月 11 日凌晨，距离上一次大的版本更新（HOOK 版本，2019.2），已经将近两年的时间，本次更新没有新特性，主要是<strong>升级简化 React 本身</strong>，为未来做准备。</p>\n<h2 id=\"逐步升级\"><a href=\"#%E9%80%90%E6%AD%A5%E5%8D%87%E7%BA%A7\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>逐步升级</h2>\n<p>当有新的版本时，可以选择部分升级，项目里可以有两个 react 的版本，<strong>但是官方都不建议这么搞</strong>，主要是为了么办法全量升级 react 的项目。\n这里有个疑问是【项目里可以有两个 react 的版本呢？】，答案是两个 package.json ，参考官方给的逐步升级 <a href=\"https://github.com/reactjs/react-gradual-upgrade-demo/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">demo</a>，看下目录结构就清楚了</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/89cb9e756169d6df4f84fa2f5c138d5f/bf505/react.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 374px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 306.7567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAA9ABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAECAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB8vNsYQaqnNFb1MQRXXNRzFf/xAAaEAEBAQEBAQEAAAAAAAAAAAABABACERIx/9oACAEBAAEFAhvpvYnCc5kwnzCc5uv2Jc//xAAUEQEAAAAAAAAAAAAAAAAAAAAw/9oACAEDAQE/AQ//xAAUEQEAAAAAAAAAAAAAAAAAAAAw/9oACAECAQE/AQ//xAAYEAACAwAAAAAAAAAAAAAAAAAQMSAwQf/aAAgBAQAGPwKCOFXf/8QAHxAAAQQBBQEAAAAAAAAAAAAAAQAQITERQVFhobFx/9oACAEBAAE/ISgLnWavCHE98ozphXlEbHlsswjHX9lroqeBoK1FwGzENlsDoN//2gAMAwEAAgADAAAAENsujLjKvP/EABQRAQAAAAAAAAAAAAAAAAAAADD/2gAIAQMBAT8QD//EABQRAQAAAAAAAAAAAAAAAAAAADD/2gAIAQIBAT8QD//EACQQAQEAAgAFAwUAAAAAAAAAAAERACExQVFhwRDR8XGBseHw/9oACAEBAAE/EHptB0D+sa73+hkSXRl3tbyvhMA6He0DziFQdhkXpLznnAVEdAT+MWqs30M6lx5Xv0yhHf644iKJE5ZC7OPOeUxd2O4++MrLO+NpKu2Hw5S1C9fQcWLe3Db3MCmpdX5fQltfY8mS4BV4+x6f/9k='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"img\"\n        title=\"\"\n        src=\"/static/89cb9e756169d6df4f84fa2f5c138d5f/bf505/react.jpg\"\n        srcset=\"/static/89cb9e756169d6df4f84fa2f5c138d5f/a80bd/react.jpg 148w,\n/static/89cb9e756169d6df4f84fa2f5c138d5f/1c91a/react.jpg 295w,\n/static/89cb9e756169d6df4f84fa2f5c138d5f/bf505/react.jpg 374w\"\n        sizes=\"(max-width: 374px) 100vw, 374px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>legacy 文件夹是老项目，modern 是新项目，分别有一个 package.json，里面就是对应的 react 版本和 其他依赖 react 版本的库（react-redux 等），这样打包的时候，遵循从内往外找依赖的原则，俩版本就可以共存了。</p>\n<h2 id=\"更改事件委托\"><a href=\"#%E6%9B%B4%E6%94%B9%E4%BA%8B%E4%BB%B6%E5%A7%94%E6%89%98\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>更改事件委托</h2>\n<p>上述的两个 react 版本共存，有一个严重的问题。react 的事件处理一直是委托到 document 处理，两个版本共存，会在顶层注册两个事件处理器，会破坏 <code class=\"language-text\">e.stopPropagation()</code>，如果一个阻止了冒泡，另一个还是会传到顶层。官方给了一个 <a href=\"https://github.com/facebook/react/pull/8117\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Atom</a> 的例子，没细看～\n基于以上原因，react 改变了事件委托对位置，在 react 17 中，事件处理器将附加到渲染 React 树的根 DOM 容器中。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nReact<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span> rootNode<span class=\"token punctuation\">)</span></code></pre></div>\n<p>17 会对事件调用 <code class=\"language-text\">rootNode.addEventListener</code>，贴张图</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e2a078bd1be2cfa7b7fb696ef21a0913/1e088/react-event.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 77.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLklEQVQoz41TSW/TQBT2vy8SEgckDlzgfyAB56qoCW0IberYTmPHy3gZz+JZ35hxnIaoXHh6svWWb94y3wRvNmLWT4n8GMv3obh6GM7OWa8exbtQfE7kh0i+fRJXL/4AKTdrqydtrENmnDwSziGv9TGh0e7SGYxnceA/tlhBl8z2+FrcnHOWCawsYAk9ZXVdss2XIVsovAcj3csBTNleASakp9Sb4NwcOlXGPcmLMstSW9yBpJYhg9NzHQComzbPiwqho+n+VvYHDUJwzvMSaUUNb5weDClAsTnJWCukpJRWqLbH/Bkd+L/Qlmvw4bLFMRkUyZ1iIInlzREJXFvmt9WRsOojYkos3LmyB2Ptnopmm6NOKtUffOfOyBnsJ2TKdNot4vzrusyZ+X2gNVUnMDewOrQ/kmJd4p9xig+/nAMrMGg+L73m6va5uomLb+vselv4TWSt8JNPYCTtfdE9DeOW2zgNd/le+m4ZcqCnyxvHbdM/YrmsdSTG75siH0zFtO8o8LGol/eIPKBu3ZJtFj8UbUmZ4N28LW7dCtFFLZeNusPmeteGLdsTLa0NjJvAy132LNymJUnbhtTUQvnrmcEDjDdJHvYy4nBbyQ1WEVF4Knxsu1UmrLqEiKiuQwapcBIuaTWmHd1hft/IVSPjwZXqdNPBzAEqVUpFyjVS4Pt8RUvrScJVRE02WM9w5S5Icspwoyek/ZfRFwkKRmWs54w2Btzlw/g/OSIn9TP/AaVAj5NzJUkZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"img\"\n        title=\"\"\n        src=\"/static/e2a078bd1be2cfa7b7fb696ef21a0913/fcda8/react-event.png\"\n        srcset=\"/static/e2a078bd1be2cfa7b7fb696ef21a0913/12f09/react-event.png 148w,\n/static/e2a078bd1be2cfa7b7fb696ef21a0913/e4a3f/react-event.png 295w,\n/static/e2a078bd1be2cfa7b7fb696ef21a0913/fcda8/react-event.png 590w,\n/static/e2a078bd1be2cfa7b7fb696ef21a0913/1e088/react-event.png 840w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>这样，两个版本对 react 事件体系就可以共存了</p>\n<ul>\n<li>解决隐患</li>\n</ul>\n<p>在 React 16 中创建的 <code class=\"language-text\">document.addEventListener</code>，即使在某个事件中调用了 <code class=\"language-text\">e.stopPropagation</code>，还是会执行，因为原生事件都已经处于 document 级别。使用 React 17 冒泡将被阻止（按需），因此 document 级别的事件监听不会触发。</p>\n<h2 id=\"其他重大更改\"><a href=\"#%E5%85%B6%E4%BB%96%E9%87%8D%E5%A4%A7%E6%9B%B4%E6%94%B9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>其他重大更改</h2>\n<ul>\n<li>\n<p><strong>对标浏览器</strong></p>\n<ul>\n<li>onScroll 事件「不再冒泡」，以防止出现常见的混淆。</li>\n<li>React 的 onFocus 和 onBlur 事件已在底层切换为原生的 focusin 和 focusout 事件。它们更接近 React 现有行为，有时还会提供额外的信息。\nReact 之前的 focus 和 blur 事件会冒泡，但是对应的原生 Dom 事件不会冒泡，而原生 DOM 的 focusin 和 focusout 事件是会冒泡的，所以切换成原生的 focusin 和 focusout 符合预期。</li>\n<li>捕获事件（例如，onClickCapture）现在使用的是实际浏览器中的捕获监听器（？不懂，浏览器引擎一类的东东？）。</li>\n</ul>\n</li>\n<li><strong>去除事件池</strong>\nReact 17 中移除了 “event pooling（事件池）”</li>\n<li>\n<p><strong>副作用清理时间</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// This is the effect itself.</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This is its cleanup.</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>副作用清理函数（如果存在）在 React 16 中同步运行，可能会在标签切换时减缓屏幕的过渡。所以在 React 17 中，副作用清理函数会异步执行，清理会在屏幕更新后执行。\n此外，React 17 会根据它们在树中的位置，以与效果相同的顺序执行清除功能。以前，顺序有时会不同。</p>\n</li>\n<li><strong>返回一致的 undefined 错误</strong>\n「在 React 17 中，forwardRef 和 memo 组件的行为会与常规函数组件和 class 组件保持一致。在返回 undefined 时会报错」</li>\n<li><strong>原生组件栈</strong>\n「在 React 17 中，使用了不同的机制生成组件堆栈，该机制会将它们与常规的原生 JavaScript 堆栈缝合在一起。这使得你可以在生产环境中获得完全符号化的 React 组件堆栈信息。」\nReact 17 的报错信息在 console 中可以看到是哪个组件抛出的错误，会打印出“组件栈”的信息，而且可以点击索引到代码位置，就像 js 抛出的错误那样。\n可以在 context 中设置 displayName 以改善调用栈信息。</li>\n<li><strong>移除私有导出</strong></li>\n</ul>\n<h2 id=\"全新的-jsx-转换\"><a href=\"#%E5%85%A8%E6%96%B0%E7%9A%84-jsx-%E8%BD%AC%E6%8D%A2\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>全新的 JSX 转换</h2>\n<ul>\n<li>\n<p>有如下源代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello World</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>旧的 jsx 转换</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'h1'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Hello world'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>新的 jsx 转换</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// 由编译器引入（禁止自己引入！）</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>jsx <span class=\"token keyword\">as</span> _jsx<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react/jsx-runtime'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">_jsx</span><span class=\"token punctuation\">(</span><span class=\"token string\">'h1'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> children<span class=\"token operator\">:</span> <span class=\"token string\">'Hello world'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://mp.weixin.qq.com/s/fpcTFFnOS6JwLi7wq3OF0w\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://mp.weixin.qq.com/s/fpcTFFnOS6JwLi7wq3OF0w</a></li>\n<li><a href=\"https://reactjs.org/blog/2020/08/10/react-v17-rc.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://reactjs.org/blog/2020/08/10/react-v17-rc.html</a></li>\n</ul>\n</li>\n</ul>","timeToRead":5,"frontmatter":{"title":"React v17.0 正式发布小记","date":"November 15, 2020","spoiler":"react 17!","cta":"react"},"fields":{"slug":"/react-17/","langKey":"en"}}},"pageContext":{"slug":"/react-17/","previous":{"fields":{"slug":"/an-android-4-4-problem/","langKey":"en","directoryName":"an-android-4-4-problem"},"frontmatter":{"title":"一个安卓 4.4 H5 的兼容性问题"}},"next":{"fields":{"slug":"/react-useEffect/","langKey":"en","directoryName":"react-useEffect"},"frontmatter":{"title":"react - useEffect 小记"}},"translations":[],"translatedLinks":[]}},"staticQueryHashes":["708209134"]}